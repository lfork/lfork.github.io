# Android 人脸识别终端程序开发踩坑指南

最近接到一个搬砖任务，使用空余时间开发了3个月 ，今天(2019年4月20日)基本上才开发完。学到了不少东西，也失去了不少东西。有得有失呀。

## 各种坑

### 图像处理(Camera1)

+ 原始图像的角度问题->原始数据的方向是固定的、横向的。

+ 显示图像的角度问题->设备的横竖屏、前置摄像头还是后置摄像头、还是USB摄像头。

+ 相机的物理旋转问题(终端设备的相机防止位置不规范)->添加相机参数的自定义配置功能，让负责部署的人员自己配置。

+ 使用Camera1的相机缓存:不缓存的话会造成OOM

### 多线程的使用

+ 过滤无效帧：一般会设置一个流程的处理状态变量 status。对这个变量的判断需要在提交线程任务之前进行判断，不然就会造成很多无效帧。

+ 使用单线程池Executors.newSingleThreadPool()来保证流程处理的单一性：避免并发调用SDK的native方法，可能会出现一些奇怪的报错。

### 几十行的libc报错

+ 解决方法1：对于接触NDK开发比较少的同学来说，可能看到一堆native(可能上百行)的报错会无所适从，但是最好还是先认真的过一遍native报错，很多情况下是我们把参数给传错了，比如传Java数组的时候，只声明了数组，但是没有定义数组元素，造成空指针异常。

+ 解决方法2：代码回退，使用DEMO里面给的代码。有的SDK的native程序里面是没有做好同步管理的(比如百度的Android离线人脸识别SDK)，我们自己在写的时候可能会忘记对方法的调用进行同步。

### 保证RGB和IR图像帧的画面一致

完全一致是很难做到的，所以我们要尽量保证在进行识别的时候用到的RGb和IR的图像帧的时间间隔不能相差太大(我在开发过程中，大概相差100ms)。

参考解决方法，先拿到RGB图像然后在轮询获取IR图像，只等50ms，没有旧判定失败，参考局部代码如下。

```java

var counter = 5
var irImageData = irImgData
while (counter > 0 && irImageData == null) {
    Thread.sleep(10)
    irImageData = irImgData
    counter--
}

if (irImageData == null) {
    LogUtil.d("identify", "没有红外信号 101")
    return
}

//活体检测
if (!livingDetect(imgDataBytes, irImageData.toBytes())) {
    LogUtil.d("identify", "活体分数低于0.7")
    setIdentityResult("0", 0f, imgDataBytes)
    return
}
```

## 学到的东西

+ 代码模块化、组件化、独立化

+ 多看开发文档和Demo，对Demo进行调试

+ 做好接口测试: 使用接口前除了看接口文档外，还要对接口进行试探性测试

## 人脸识别处理流程参考(双目相机，云从SDK)：

+ 人脸框使用一个线程来单独绘制，

+ 一个线程来提取RGB数据并解析并且负责红外活体检测

+ 一个线程来提取IR数据并解析

+ 一个线程来进行人脸的特征提取和人脸对比